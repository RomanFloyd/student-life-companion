<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Student Life Companion</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 40px auto; }
    textarea { width: 100%; height: 60px; }
    button { padding: 8px 12px; margin-top: 5px; }
    .card { border: 1px solid #ccc; padding: 10px; border-radius: 10px; margin-top: 10px; }
  </style>
</head>
<body style="background: white; color: black;">
  <h1 style="color: blue;">Student Life Companion</h1>
  <p style="color: green; font-weight: bold;">‚úì Page loaded successfully!</p>

  <!-- –æ–∫–Ω–æ –≤–≤–æ–¥–∞ -->
  <textarea id="question" placeholder="Ask something about visa, work or taxes..."></textarea>
  <br>
  <button onclick="submitQuestion()">Ask</button>

  <!-- —Å—é–¥–∞ –ø–æ–π–¥—ë—Ç –æ—Ç–≤–µ—Ç -->
  <div id="answer"></div>

  <h3>History</h3>
  <!-- —Å—é–¥–∞ –ø–æ–¥–≥—Ä—É–∑–∏—Ç—Å—è –∏—Å—Ç–æ—Ä–∏—è -->
  <div id="history"></div>

  <script>
  // === –ü—É–Ω–∫—Ç 1: —Ñ—É–Ω–∫—Ü–∏—è askAssistant ===
  async function askAssistant(userQuestion) {
    const url = `http://127.0.0.1:8000/ask?query=${encodeURIComponent(userQuestion)}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('API error');
    const data = await res.json();
    return data;
  }

  // === –ü—É–Ω–∫—Ç 1 (–≤—Ç–æ—Ä–∞—è —á–∞—Å—Ç—å): renderAnswer ===
  function renderAnswer(data) {
    const badge = data.verified ? "‚úÖ Verified" : (data.source === "external" ? "üåê External" : "üí¨ Internal");
    document.querySelector('#answer').innerHTML = `
      <div class="card">
        <div><strong>Source:</strong> ${badge}
          ${data.source_url ? `&nbsp;‚Ä¢&nbsp;<a href="${data.source_url}" target="_blank">Official link</a>` : ""}
        </div>
        <p>${data.answer}</p>
        ${Array.isArray(data.steps) ? `<ol>${data.steps.map(s => `<li>${s}</li>`).join("")}</ol>` : ""}
      </div>
    `;
  }

  // === –ü—É–Ω–∫—Ç 2: –∏—Å—Ç–æ—Ä–∏—è ===
  async function loadHistory() {
    const res = await fetch('http://127.0.0.1:8000/history?limit=10');
    const items = await res.json();
    const list = items.map(r => `
      <li>
        <span>${new Date(r.ts * 1000).toLocaleString()}</span> ‚Äî
        <em>${r.query}</em> ‚Üí <small>${r.source}</small>
      </li>
    `).join("");
    document.querySelector('#history').innerHTML = `<ul>${list}</ul>`;
  }

  // === –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ ===
  async function submitQuestion() {
    const q = document.querySelector('#question').value.trim();
    if (!q) return alert("Please enter a question");
    const data = await askAssistant(q);
    renderAnswer(data);
    loadHistory();
  }

  // === –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ===
  // –û–±–µ—Ä–Ω–µ–º –≤ try-catch —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–Ω–¥–µ—Ä
  loadHistory().catch(err => {
    console.error('Failed to load history:', err);
    document.querySelector('#history').innerHTML = '<p style="color:red;">Failed to load history. Check console.</p>';
  });
  </script>
</body>
</html>
