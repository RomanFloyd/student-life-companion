<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Life Companion 🎓</title>
  <style>
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f5f7fa;
      --bg-card: #ffffff;
      --text-primary: #1a1a1a;
      --text-secondary: #666666;
      --border-color: #e0e0e0;
      --shadow: 0 2px 8px rgba(0,0,0,0.1);
      --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --accent-blue: #2196F3;
      --accent-green: #4CAF50;
      --accent-orange: #FF9800;
    }
    
    [data-theme="dark"] {
      --bg-primary: #1a1a2e;
      --bg-secondary: #16213e;
      --bg-card: #0f3460;
      --text-primary: #eaeaea;
      --text-secondary: #b0b0b0;
      --border-color: #2d3748;
      --shadow: 0 2px 16px rgba(0,0,0,0.4);
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      transition: all 0.3s ease;
      padding: 20px;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      padding: 30px 0;
      background: var(--gradient-primary);
      border-radius: 20px;
      margin-bottom: 30px;
      box-shadow: var(--shadow);
      animation: slideDown 0.5s ease;
    }
    
    .header h1 {
      color: white;
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    
    .header p {
      color: rgba(255,255,255,0.9);
      font-size: 1.1em;
    }
    
    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--bg-card);
      border: 2px solid var(--border-color);
      border-radius: 50px;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 1.2em;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
      z-index: 1000;
    }
    
    .theme-toggle:hover {
      transform: scale(1.1);
    }
    
    .search-box {
      background: var(--bg-card);
      padding: 25px;
      border-radius: 15px;
      box-shadow: var(--shadow);
      margin-bottom: 30px;
      animation: fadeIn 0.5s ease;
    }
    
    textarea {
      width: 100%;
      height: 80px;
      padding: 15px;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      font-size: 16px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      resize: vertical;
      transition: all 0.3s ease;
      font-family: inherit;
    }
    
    textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .btn-primary {
      background: var(--gradient-primary);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 15px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    .btn-primary:active {
      transform: translateY(0);
    }
    
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      padding: 25px;
      border-radius: 15px;
      margin-top: 20px;
      box-shadow: var(--shadow);
      animation: slideUp 0.4s ease;
    }
    
    .topic-icon {
      font-size: 1.5em;
      margin-right: 8px;
    }
    
    .cost-badge, .deadline-badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      margin-left: 10px;
      animation: bounceIn 0.5s ease;
    }
    
    .cost-badge {
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
    }
    
    .deadline-badge {
      background: linear-gradient(135deg, #FF9800, #f57c00);
      color: white;
    }
    
    .contacts {
      margin-top: 20px;
      padding: 15px;
      background: linear-gradient(135deg, rgba(33, 150, 243, 0.1), rgba(33, 150, 243, 0.05));
      border-radius: 10px;
      border-left: 4px solid var(--accent-blue);
    }
    
    .contact-item {
      margin: 8px 0;
      padding: 5px 0;
    }
    
    .contact-item a {
      color: var(--accent-blue);
      text-decoration: none;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .contact-item a:hover {
      text-decoration: underline;
      color: #1976d2;
    }
    
    .quick-links {
      margin-top: 20px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .quick-link-btn {
      display: inline-block;
      padding: 10px 20px;
      background: var(--gradient-primary);
      color: white;
      text-decoration: none;
      border-radius: 25px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }
    
    .quick-link-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .related-topics {
      margin-top: 20px;
      padding: 15px;
      background: linear-gradient(135deg, rgba(255, 152, 0, 0.1), rgba(255, 152, 0, 0.05));
      border-radius: 10px;
      border-left: 4px solid var(--accent-orange);
    }
    
    .related-tag {
      display: inline-block;
      background: linear-gradient(135deg, #FFE0B2, #FFCC80);
      color: #E65100;
      padding: 6px 12px;
      border-radius: 15px;
      font-size: 13px;
      margin: 4px;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .related-tag:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(230, 81, 0, 0.2);
    }
    
    .history-section {
      margin-top: 40px;
      background: var(--bg-card);
      padding: 25px;
      border-radius: 15px;
      box-shadow: var(--shadow);
    }
    
    .history-section h3 {
      color: var(--text-primary);
      margin-bottom: 15px;
      font-size: 1.5em;
    }
    
    .history-section ul {
      list-style: none;
    }
    
    .history-section li {
      padding: 12px;
      margin: 8px 0;
      background: var(--bg-secondary);
      border-radius: 8px;
      border-left: 3px solid #667eea;
      transition: all 0.2s ease;
    }
    
    .history-section li:hover {
      transform: translateX(5px);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    }
    
    .topic-filters {
      background: var(--bg-card);
      padding: 20px;
      border-radius: 15px;
      box-shadow: var(--shadow);
      margin-bottom: 30px;
      animation: fadeIn 0.5s ease;
    }
    
    .topic-filters h3 {
      margin-bottom: 15px;
      color: var(--text-primary);
      font-size: 1.2em;
    }
    
    .filter-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .filter-btn {
      padding: 10px 20px;
      border: 2px solid var(--border-color);
      background: var(--bg-secondary);
      color: var(--text-primary);
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .filter-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
      border-color: #667eea;
    }
    
    .filter-btn.active {
      background: var(--gradient-primary);
      color: white;
      border-color: transparent;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    .filter-btn .count {
      background: rgba(255,255,255,0.2);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 12px;
    }
    
    .filter-btn.active .count {
      background: rgba(255,255,255,0.3);
    }
    
    .questions-list {
      margin-top: 20px;
    }
    
    .question-item {
      background: var(--bg-card);
      padding: 15px;
      margin: 10px 0;
      border-radius: 10px;
      border-left: 4px solid #667eea;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow);
    }
    
    .question-item:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }
    
    .question-item h4 {
      color: var(--text-primary);
      margin-bottom: 8px;
      font-size: 1em;
    }
    
    .question-item p {
      color: var(--text-secondary);
      font-size: 0.9em;
      line-height: 1.5;
    }
    
    .rating-section {
      margin-top: 20px;
      padding: 15px;
      background: var(--bg-secondary);
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .rating-section p {
      margin: 0;
      color: var(--text-primary);
      font-weight: 500;
    }
    
    .rating-buttons {
      display: flex;
      gap: 10px;
    }
    
    .rating-btn {
      background: var(--bg-card);
      border: 2px solid var(--border-color);
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 1.2em;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .rating-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .rating-btn.liked {
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
      border-color: transparent;
    }
    
    .rating-btn.disliked {
      background: linear-gradient(135deg, #f44336, #d32f2f);
      color: white;
      border-color: transparent;
    }
    
    .rating-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .popular-section {
      background: var(--bg-card);
      padding: 25px;
      border-radius: 15px;
      box-shadow: var(--shadow);
      margin-bottom: 30px;
      animation: fadeIn 0.5s ease;
    }
    
    .popular-section h3 {
      margin-bottom: 15px;
      color: var(--text-primary);
      font-size: 1.3em;
    }
    
    .popular-item {
      background: var(--bg-secondary);
      padding: 12px 15px;
      margin: 10px 0;
      border-radius: 8px;
      border-left: 4px solid #4CAF50;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .popular-item:hover {
      transform: translateX(5px);
      box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
    }
    
    .popular-item .question-text {
      flex: 1;
      color: var(--text-primary);
      font-weight: 500;
    }
    
    .popular-item .rating-stats {
      display: flex;
      gap: 10px;
      font-size: 0.9em;
    }
    
    .popular-item .stat {
      padding: 4px 10px;
      border-radius: 12px;
      background: rgba(76, 175, 80, 0.1);
      color: #4CAF50;
    }
    
    @keyframes slideDown {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes bounceIn {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.05); }
      70% { transform: scale(0.9); }
      100% { transform: scale(1); opacity: 1; }
    }
    
    /* Profile Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      animation: fadeIn 0.3s ease;
    }
    
    .modal-content {
      background-color: var(--bg-card);
      margin: 10% auto;
      padding: 30px;
      border-radius: 15px;
      max-width: 600px;
      box-shadow: var(--shadow);
      animation: bounceIn 0.5s ease;
    }
    
    .modal-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .modal-header h2 {
      color: var(--text-primary);
      margin-bottom: 10px;
    }
    
    .modal-header p {
      color: var(--text-secondary);
    }
    
    .profile-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .profile-card {
      background: var(--bg-secondary);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }
    
    .profile-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      border-color: #667eea;
    }
    
    .profile-card.selected {
      border-color: #667eea;
      background: linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.1) 100%);
    }
    
    .profile-icon {
      font-size: 2.5em;
      margin-bottom: 10px;
    }
    
    .profile-name {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 5px;
    }
    
    .profile-desc {
      font-size: 0.85em;
      color: var(--text-secondary);
    }
    
    .modal-footer {
      text-align: center;
      margin-top: 20px;
    }
    
    .profile-btn {
      background: var(--gradient-primary);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .profile-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(102,126,234,0.4);
    }
    
    .profile-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .current-profile {
      display: inline-block;
      background: var(--bg-secondary);
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.9em;
      margin-left: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .current-profile:hover {
      background: var(--gradient-primary);
      color: white;
    }
    
    @media (max-width: 768px) {
      .header h1 { font-size: 1.8em; }
      .container { padding: 10px; }
      .theme-toggle { top: 10px; right: 10px; }
      .profile-grid { grid-template-columns: 1fr; }
      .modal-content { margin: 20% auto; padding: 20px; }
    }
  </style>
</head>
<body>
  <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">🌙</button>
  
  <!-- Profile Modal -->
  <div id="profileModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>👤 Select Your Profile</h2>
        <p>Choose your profile to get personalized help</p>
      </div>
      <div class="profile-grid" id="profileGrid"></div>
      <div class="modal-footer">
        <button class="profile-btn" id="saveProfileBtn" onclick="saveProfile()" disabled>Save Profile</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="header">
      <h1>🎓 Student Life Companion</h1>
      <p>
        Your AI assistant for life at Harbour.Space Barcelona
        <span id="currentProfile" class="current-profile" onclick="openProfileModal()" style="display:none;"></span>
      </p>
    </div>

    <div class="popular-section">
      <h3>🔥 Most Popular Questions</h3>
      <div id="popularQuestions"></div>
    </div>

    <div class="topic-filters">
      <h3>🔍 Browse by Topic</h3>
      <div class="filter-buttons" id="topicFilters"></div>
      <div class="questions-list" id="questionsList"></div>
    </div>

    <div class="search-box">
      <textarea id="question" placeholder="Ask me anything: visa 🛂, housing 🏠, transport 🚇, university 🎓, food 🍕, discounts 💰..."></textarea>
      <button class="btn-primary" onclick="submitQuestion()">🔍 Ask Question</button>
    </div>

    <!-- сюда пойдёт ответ -->
    <div id="answer"></div>

    <div class="history-section">
      <h3>📜 Recent Questions</h3>
      <div id="history"></div>
    </div>
  </div>

  <script>
  // API Base URL - automatically uses current host
  const API_BASE = window.location.origin;
  
  // Topic icons mapping
  const TOPIC_ICONS = {
    'visa': '🛂',
    'work': '💼',
    'tax': '💰',
    'housing': '🏠',
    'transport': '🚇',
    'healthcare': '🏥',
    'banking': '🏦',
    'mobile': '📱',
    'admin': '📋',
    'university': '🎓',
    'life': '🌆'
  };
  
  // Theme toggle
  function toggleTheme() {
    const body = document.body;
    const currentTheme = body.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? '' : 'dark';
    body.setAttribute('data-theme', newTheme);
    
    const btn = document.querySelector('.theme-toggle');
    btn.textContent = newTheme === 'dark' ? '☀️' : '🌙';
    
    // Save preference
    localStorage.setItem('theme', newTheme);
  }
  
  // Profile management
  let selectedProfile = null;
  let currentUserProfile = null;
  
  function getUserId() {
    let userId = localStorage.getItem('userId');
    if (!userId) {
      userId = 'web_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('userId', userId);
    }
    return userId;
  }
  
  async function loadProfiles() {
    try {
      const response = await fetch(`${API_BASE}/profiles`);
      const data = await response.json();
      const grid = document.getElementById('profileGrid');
      grid.innerHTML = '';
      
      const profileIcons = {
        'student-longterm': '📚',
        'teacher-shortterm': '👨‍🏫',
        'exchange-visiting': '🌍',
        'just-arrived': '🛬'
      };
      
      data.profiles.forEach(profile => {
        const card = document.createElement('div');
        card.className = 'profile-card';
        card.onclick = () => selectProfile(profile.id);
        card.innerHTML = `
          <div class="profile-icon">${profileIcons[profile.id]}</div>
          <div class="profile-name">${profile.name.replace(/^[^\s]+\s/, '')}</div>
          <div class="profile-desc">${profile.description}</div>
        `;
        card.dataset.profileId = profile.id;
        grid.appendChild(card);
      });
    } catch (error) {
      console.error('Error loading profiles:', error);
    }
  }
  
  function selectProfile(profileId) {
    selectedProfile = profileId;
    document.querySelectorAll('.profile-card').forEach(card => {
      card.classList.remove('selected');
      if (card.dataset.profileId === profileId) {
        card.classList.add('selected');
      }
    });
    document.getElementById('saveProfileBtn').disabled = false;
  }
  
  async function saveProfile() {
    if (!selectedProfile) return;
    
    try {
      const response = await fetch(`${API_BASE}/profile`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          user_id: getUserId(),
          profile_type: selectedProfile
        })
      });
      
      const data = await response.json();
      if (data.status === 'success') {
        currentUserProfile = selectedProfile;
        updateProfileDisplay();
        closeProfileModal();
      }
    } catch (error) {
      console.error('Error saving profile:', error);
      alert('Error saving profile. Please try again.');
    }
  }
  
  async function loadUserProfile() {
    try {
      const response = await fetch(`${API_BASE}/profile/${getUserId()}`);
      const data = await response.json();
      
      if (data.status === 'success') {
        currentUserProfile = data.profile;
        updateProfileDisplay();
      } else {
        // No profile - show modal
        openProfileModal();
      }
    } catch (error) {
      console.error('Error loading user profile:', error);
    }
  }
  
  function updateProfileDisplay() {
    const profileNames = {
      'student-longterm': '📚 Student',
      'teacher-shortterm': '👨‍🏫 Teacher',
      'exchange-visiting': '🌍 Exchange',
      'just-arrived': '🛬 Just Arrived'
    };
    
    const profileSpan = document.getElementById('currentProfile');
    if (currentUserProfile) {
      profileSpan.textContent = profileNames[currentUserProfile];
      profileSpan.style.display = 'inline-block';
    }
  }
  
  function openProfileModal() {
    loadProfiles();
    document.getElementById('profileModal').style.display = 'block';
  }
  
  function closeProfileModal() {
    document.getElementById('profileModal').style.display = 'none';
  }
  
  // Close modal when clicking outside
  window.onclick = function(event) {
    const modal = document.getElementById('profileModal');
    if (event.target === modal) {
      closeProfileModal();
    }
  }
  
  // Load saved theme
  window.addEventListener('DOMContentLoaded', () => {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      document.body.setAttribute('data-theme', 'dark');
      document.querySelector('.theme-toggle').textContent = '☀️';
    }
    
    // Load user profile
    loadUserProfile();
    
    // Load topic filters and popular questions
    loadTopicFilters();
    loadPopularQuestions();
  });
  
  // Rate answer
  async function rateAnswer(rating, question, topic) {
    try {
      const userQuery = document.getElementById('question').value;
      
      const res = await fetch(`${API_BASE}/rate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          question: question,
          topic: topic,
          rating: rating,
          user_query: userQuery
        })
      });
      
      if (res.ok) {
        // Update button states
        const likeBtn = document.getElementById('likeBtn');
        const dislikeBtn = document.getElementById('dislikeBtn');
        
        if (rating === 1) {
          likeBtn.classList.add('liked');
          likeBtn.disabled = true;
          dislikeBtn.disabled = true;
        } else {
          dislikeBtn.classList.add('disliked');
          dislikeBtn.disabled = true;
          likeBtn.disabled = true;
        }
        
        // Reload popular questions
        loadPopularQuestions();
      }
    } catch (err) {
      console.error('Failed to rate answer:', err);
    }
  }
  
  // Load popular questions
  async function loadPopularQuestions() {
    try {
      const res = await fetch(`${API_BASE}/popular?limit=5`);
      const data = await res.json();
      
      const container = document.getElementById('popularQuestions');
      
      if (data.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No ratings yet. Be the first to rate an answer!</p>';
        return;
      }
      
      const itemsHTML = data.map((item, index) => {
        const icon = TOPIC_ICONS[item.topic] || '📌';
        return `
          <div class="popular-item" onclick="askQuestion('${item.question.replace(/'/g, "\\'")}')">
            <span class="question-text">${index + 1}. ${icon} ${item.question}</span>
            <div class="rating-stats">
              <span class="stat">👍 ${item.likes}</span>
              ${item.dislikes > 0 ? `<span class="stat" style="background: rgba(244, 67, 54, 0.1); color: #f44336;">👎 ${item.dislikes}</span>` : ''}
              <span class="stat" style="background: rgba(102, 126, 234, 0.1); color: #667eea;">⭐ ${item.score}</span>
            </div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = itemsHTML;
    } catch (err) {
      console.error('Failed to load popular questions:', err);
    }
  }
  
  // Load topic filters
  async function loadTopicFilters() {
    try {
      const res = await fetch(`${API_BASE}/topics`);
      const data = await res.json();
      
      const filtersContainer = document.getElementById('topicFilters');
      const topics = data.topics;
      
      // Add "All" button
      let buttonsHTML = `<button class="filter-btn active" onclick="filterByTopic('all')">
        <span>📚 All Topics</span>
        <span class="count">${Object.values(topics).reduce((a, b) => a + b, 0)}</span>
      </button>`;
      
      // Add topic buttons
      for (const [topic, count] of Object.entries(topics).sort()) {
        const icon = TOPIC_ICONS[topic] || '📌';
        buttonsHTML += `<button class="filter-btn" onclick="filterByTopic('${topic}')">
          <span>${icon} ${topic.charAt(0).toUpperCase() + topic.slice(1)}</span>
          <span class="count">${count}</span>
        </button>`;
      }
      
      filtersContainer.innerHTML = buttonsHTML;
    } catch (err) {
      console.error('Failed to load topics:', err);
    }
  }
  
  // Filter questions by topic
  async function filterByTopic(topic) {
    // Update active button
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    event.target.closest('.filter-btn').classList.add('active');
    
    const questionsContainer = document.getElementById('questionsList');
    
    if (topic === 'all') {
      questionsContainer.innerHTML = '';
      return;
    }
    
    try {
      const res = await fetch(`${API_BASE}/questions/${topic}`);
      const data = await res.json();
      
      if (data.questions.length === 0) {
        questionsContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 20px;">No questions found for this topic.</p>';
        return;
      }
      
      const questionsHTML = data.questions.map(q => `
        <div class="question-item" onclick="askQuestion('${q.question.replace(/'/g, "\\'")}')">
          <h4>${TOPIC_ICONS[q.topic] || '📌'} ${q.question}</h4>
          <p>${q.answer.substring(0, 120)}${q.answer.length > 120 ? '...' : ''}</p>
        </div>
      `).join('');
      
      questionsContainer.innerHTML = questionsHTML;
    } catch (err) {
      console.error('Failed to load questions:', err);
      questionsContainer.innerHTML = '<p style="color: red;">Failed to load questions.</p>';
    }
  }
  
  // Ask a specific question
  function askQuestion(question) {
    document.getElementById('question').value = question;
    submitQuestion();
    // Scroll to answer
    setTimeout(() => {
      document.getElementById('answer').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
  }
  
  // === Пункт 1: функция askAssistant ===
  async function askAssistant(userQuestion) {
    const url = `${API_BASE}/ask?query=${encodeURIComponent(userQuestion)}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('API error');
    const data = await res.json();
    return data;
  }

  // === Пункт 1 (вторая часть): renderAnswer ===
  function renderAnswer(data) {
    const topicIcon = TOPIC_ICONS[data.topic] || '📌';
    const badge = data.verified ? "✅ Verified" : (data.source === "external" ? "🌐 External" : "💬 Internal");
    
    // Contacts section
    let contactsHTML = '';
    if (data.contacts && data.contacts.length > 0) {
      const contactItems = data.contacts.map(c => {
        if (c.type === 'email') {
          return `<div class="contact-item">📧 <strong>${c.label}:</strong> <a href="mailto:${c.value}">${c.value}</a></div>`;
        } else if (c.type === 'phone') {
          return `<div class="contact-item">📞 <strong>${c.label}:</strong> <a href="tel:${c.value}">${c.value}</a></div>`;
        } else if (c.type === 'discord') {
          return `<div class="contact-item">💬 <strong>${c.label}:</strong> <a href="${c.value}" target="_blank">Join Discord</a></div>`;
        }
        return '';
      }).join('');
      contactsHTML = `<div class="contacts"><strong>📞 Contacts:</strong>${contactItems}</div>`;
    }
    
    // Quick links section
    let quickLinksHTML = '';
    if (data.quick_links && data.quick_links.length > 0) {
      const linkButtons = data.quick_links.map(link => 
        `<a href="${link.url}" target="_blank" class="quick-link-btn">${link.label}</a>`
      ).join('');
      quickLinksHTML = `<div class="quick-links">${linkButtons}</div>`;
    }
    
    // Cost badge
    const costBadge = data.cost ? `<span class="cost-badge">💰 ${data.cost}</span>` : '';
    
    // Deadline badge
    const deadlineBadge = data.deadline ? `<span class="deadline-badge">${data.deadline}</span>` : '';
    
    // Related topics section
    let relatedHTML = '';
    if (data.related_topics && data.related_topics.length > 0) {
      const tags = data.related_topics.map(topic => `<span class="related-tag">🔗 ${topic}</span>`).join('');
      relatedHTML = `<div class="related-topics"><strong>📌 Related topics:</strong><br>${tags}</div>`;
    }
    
    document.querySelector('#answer').innerHTML = `
      <div class="card">
        <div style="margin-bottom: 15px;">
          <span class="topic-icon">${topicIcon}</span>
          <strong style="font-size: 1.1em;">${data.topic ? data.topic.toUpperCase() : 'INFO'}</strong>
          <span style="margin-left: 10px;">${badge}</span>
          ${data.source_url ? `&nbsp;•&nbsp;<a href="${data.source_url}" target="_blank" style="color: var(--accent-blue);">🔗 Official link</a>` : ""}
          ${costBadge}
          ${deadlineBadge}
        </div>
        <p style="font-size: 1.1em; line-height: 1.6; margin: 15px 0;"><strong>${data.answer}</strong></p>
        ${Array.isArray(data.steps) ? `<ol style="margin: 15px 0; padding-left: 25px; line-height: 1.8;">${data.steps.map(s => `<li style="margin: 8px 0;">${s}</li>`).join("")}</ol>` : ""}
        ${contactsHTML}
        ${quickLinksHTML}
        ${relatedHTML}
        <div class="rating-section">
          <p>Was this answer helpful?</p>
          <div class="rating-buttons">
            <button class="rating-btn" id="likeBtn" onclick="rateAnswer(1, '${data.matched_question?.replace(/'/g, "\\'")}', '${data.topic}')">
              👍 Helpful
            </button>
            <button class="rating-btn" id="dislikeBtn" onclick="rateAnswer(-1, '${data.matched_question?.replace(/'/g, "\\'")}', '${data.topic}')">
              👎 Not helpful
            </button>
          </div>
        </div>
      </div>
    `;
  }

  // === Пункт 2: история ===
  async function loadHistory() {
    const res = await fetch(`${API_BASE}/history?limit=10`);
    const items = await res.json();
    const list = items.map(r => `
      <li>
        <span>${new Date(r.ts * 1000).toLocaleString()}</span> —
        <em>${r.query}</em> → <small>${r.source}</small>
      </li>
    `).join("");
    document.querySelector('#history').innerHTML = `<ul>${list}</ul>`;
  }

  // === помощник для кнопки ===
  async function submitQuestion() {
    const q = document.querySelector('#question').value.trim();
    if (!q) return alert("Please enter a question");
    const data = await askAssistant(q);
    renderAnswer(data);
    loadHistory();
  }

  // === при загрузке страницы ===
  // Обернем в try-catch чтобы не блокировать рендер
  loadHistory().catch(err => {
    console.error('Failed to load history:', err);
    document.querySelector('#history').innerHTML = '<p style="color:red;">Failed to load history. Check console.</p>';
  });
  </script>
</body>
</html>
