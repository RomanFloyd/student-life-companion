# üì° API Documentation

Base URL: `http://127.0.0.1:8888` (local) or your deployed URL

---

## üîç Query Endpoints

### `GET /ask`

Main Q&A endpoint. Searches knowledge base and falls back to Groq LLM.

**Parameters:**
- `query` (string, required) - User's question
- `min_score` (float, optional, default: 0.35) - Minimum similarity threshold
- `autosave` (bool, optional, default: true) - Save to history

**Response:**
```json
{
  "answer": "You need passport with entry stamp, empadronamiento...",
  "matched_question": "What documents do I need for TIE card application?",
  "topic": "visa",
  "steps": [
    "Prepare passport copy, EX-17, photo, tasa 790-012 receipt",
    "Book 'Polic√≠a ‚Äì Toma de huellas' in Barcelona",
    "Bring documents to the appointment"
  ],
  "source_url": "https://icp.administracionelectronica.gob.es",
  "verified": true,
  "similarity": 0.856,
  "source": "internal-semantic",
  "cost": "‚Ç¨16.08",
  "contacts": [
    {
      "type": "email",
      "label": "Student Experience",
      "value": "student.experience@harbour.space"
    }
  ],
  "quick_links": [
    {
      "label": "üìÖ Book TIE Appointment",
      "url": "https://icp.administracionelectronica.gob.es"
    }
  ],
  "deadline": "‚è∞ Book within 30 days of arrival",
  "related_topics": ["empadronamiento", "toma de huellas", "passport"]
}
```

**Source Types:**
- `internal-semantic` - Found in knowledge base via embeddings
- `internal-fallback` - Found in knowledge base via keyword match
- `llm-groq` - Generated by Groq LLM

**Example:**
```bash
curl "http://127.0.0.1:8888/ask?query=How%20to%20book%20TIE%20appointment"
```

---

### `GET /reload`

Reload knowledge base and rebuild embeddings.

**Response:**
```json
{
  "status": "reloaded",
  "items": 42
}
```

**Example:**
```bash
curl "http://127.0.0.1:8888/reload"
```

---

## üìö Knowledge Base Endpoints

### `GET /topics`

Get all topics with question counts.

**Response:**
```json
{
  "topics": {
    "visa": 8,
    "housing": 6,
    "banking": 4,
    "healthcare": 3,
    "transport": 5,
    "mobile": 3,
    "life": 7,
    "university": 4,
    "admin": 2
  }
}
```

**Example:**
```bash
curl "http://127.0.0.1:8888/topics"
```

---

### `GET /questions/{topic}`

Get all questions for a specific topic.

**Parameters:**
- `topic` (string, required) - Topic name (e.g., "visa", "housing")

**Response:**
```json
{
  "topic": "visa",
  "count": 8,
  "questions": [
    {
      "question": "How to renew student visa?",
      "answer": "Renew your student residence and then book TOMA DE HUELLAS...",
      "topic": "visa"
    },
    ...
  ]
}
```

**Example:**
```bash
curl "http://127.0.0.1:8888/questions/visa"
```

---

## ‚≠ê Rating Endpoints

### `POST /rate`

Rate an answer (thumbs up/down).

**Request Body:**
```json
{
  "question": "What documents do I need for TIE card application?",
  "topic": "visa",
  "rating": 1,
  "user_query": "how to get TIE card"
}
```

**Fields:**
- `question` (string, required) - Matched question from KB
- `topic` (string, optional) - Topic of the question
- `rating` (integer, required) - 1 for üëç, -1 for üëé
- `user_query` (string, optional) - Original user query

**Response:**
```json
{
  "status": "success",
  "message": "Rating saved"
}
```

**Example:**
```bash
curl -X POST "http://127.0.0.1:8888/rate" \
  -H "Content-Type: application/json" \
  -d '{"question": "How to book TIE?", "rating": 1}'
```

---

### `GET /popular`

Get most popular questions based on ratings.

**Parameters:**
- `limit` (integer, optional, default: 5) - Number of questions to return

**Response:**
```json
[
  {
    "question": "How to book Toma de huellas appointment?",
    "topic": "visa",
    "likes": 15,
    "dislikes": 2,
    "score": 13
  },
  ...
]
```

**Example:**
```bash
curl "http://127.0.0.1:8888/popular?limit=10"
```

---

## üë§ Profile Endpoints

### `POST /profile`

Set or update user profile.

**Request Body:**
```json
{
  "user_id": "web_abc123",
  "profile_type": "student-longterm"
}
```

**Fields:**
- `user_id` (string, required) - Unique user identifier
- `profile_type` (string, required) - One of:
  - `student-longterm`
  - `teacher-shortterm`
  - `exchange-visiting`
  - `just-arrived`
  - `other`

**Response:**
```json
{
  "status": "success",
  "profile": "student-longterm"
}
```

**Error Response:**
```json
{
  "status": "error",
  "message": "Invalid profile. Choose from: [...]"
}
```

**Example:**
```bash
curl -X POST "http://127.0.0.1:8888/profile" \
  -H "Content-Type: application/json" \
  -d '{"user_id": "web_abc123", "profile_type": "student-longterm"}'
```

---

### `GET /profile/{user_id}`

Get user profile.

**Parameters:**
- `user_id` (string, required) - User identifier

**Response (found):**
```json
{
  "status": "success",
  "profile": "student-longterm",
  "created_at": 1697472000
}
```

**Response (not found):**
```json
{
  "status": "not_found",
  "profile": null
}
```

**Example:**
```bash
curl "http://127.0.0.1:8888/profile/web_abc123"
```

---

### `GET /profiles`

Get list of available profiles.

**Response:**
```json
{
  "profiles": [
    {
      "id": "student-longterm",
      "name": "üìö Student (long-term)",
      "description": "Full degree program (1-4 years)",
      "topics": ["visa", "housing", "banking", "healthcare", ...]
    },
    {
      "id": "teacher-shortterm",
      "name": "üë®‚Äçüè´ Teacher (3-9 weeks)",
      "description": "Short-term teaching position",
      "topics": ["housing", "transport", "life", "mobile"]
    },
    ...
  ]
}
```

**Example:**
```bash
curl "http://127.0.0.1:8888/profiles"
```

---

## üìú History Endpoints

### `GET /history`

Get query history.

**Parameters:**
- `limit` (integer, optional, default: 10) - Number of records to return

**Response:**
```json
[
  {
    "id": 123,
    "ts": 1697472000,
    "query": "How to book TIE appointment?",
    "answer": "Book online at ICP portal...",
    "matched_question": "How to book Toma de huellas?",
    "topic": "visa",
    "similarity": 0.856,
    "source": "internal-semantic"
  },
  ...
]
```

**Example:**
```bash
curl "http://127.0.0.1:8888/history?limit=20"
```

---

## üåê Static Files

### `GET /static/frontend.html`

Web frontend interface.

**Example:**
```
http://127.0.0.1:8888/static/frontend.html
```

---

## ‚ö†Ô∏è Error Handling

All endpoints return appropriate HTTP status codes:

- `200 OK` - Success
- `400 Bad Request` - Invalid parameters
- `404 Not Found` - Resource not found
- `500 Internal Server Error` - Server error

**Error Response Format:**
```json
{
  "detail": "Error message here"
}
```

---

## üîí Rate Limiting

### Groq API Limits:
- 30 requests per minute
- 14,400 requests per day

**Recommendation:** Implement client-side caching for repeated queries.

---

## üìä Response Times

Typical response times:

| Endpoint | Average | Max |
|----------|---------|-----|
| `/ask` (KB hit) | 50-100ms | 200ms |
| `/ask` (Groq fallback) | 300-500ms | 1000ms |
| `/topics` | 5-10ms | 20ms |
| `/profile` | 5-10ms | 20ms |
| `/popular` | 10-20ms | 50ms |

---

## üß™ Testing

### Health Check:
```bash
curl "http://127.0.0.1:8888/"
```

### Test Query:
```bash
curl "http://127.0.0.1:8888/ask?query=hello"
```

### Test with jq (pretty print):
```bash
curl -s "http://127.0.0.1:8888/ask?query=How%20to%20book%20TIE" | jq
```

---

## üìö Related Documentation

- [Architecture](ARCHITECTURE.md)
- [Telegram Bot Setup](../TELEGRAM_BOT_SETUP.md)
- [README](../README.md)
